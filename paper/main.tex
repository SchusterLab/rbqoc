\documentclass[
  amsfonts,
  amsmath,
  tbtags,
  amssymb,
  aps,
  nobibnotes,
  %% prl,
  twocolumn,
  superscriptaddress,
]{revtex4-2}

\input{preamble}

\begin{document}


%% TITLE
\title{Robust Control of a Fluxonium Qubit}

\author{Thomas Propson}
\email{tcpropson@uchicago.edu}
\affiliation{
  James Franck Institute, University of Chicago, Chicago, Illinois 60637, USA
}
\affiliation{
  Department of Physics, University of Chicago, Chicago, Illinois 60637, USA
}
\author{Brian Jackson}
\author{Zac Manchester}
\affiliation{
  Department of Aeronautics and Astronautics Engineering, Stanford University, 496 Lomita Mall, Stanford, CA 94305
}
\author{David I. Schuster}
\affiliation{
  James Franck Institute, University of Chicago, Chicago, Illinois 60637, USA
}
\affiliation{
  Department of Physics, University of Chicago, Chicago, Illinois 60637, USA
}
\affiliation{
  Pritzker School of Molecular Engineering, University of Chicago, Chicago, Illinois 60637, USA
}

\date{\today}


%% ABSTRACT
\begin{abstract}
  %% - 1 + 2 topic importance
  %% - 1 what I have done
  %% - few sentences about primary results
  The ability to engineer high fidelity operations on quantum processors in the presence of
  systematic errors and decoherence remains the primary challenge requisite to achieving quantum advantage.
  Quantum optimal control (QOC) techniques have proven effective in realizing high fidelity operations,
  but they require exquisite calibration to be performant.
  In this work we employ robust trajectory optimization techniques
  to achieve high fidelity gates for parameter spreads on the order of $1\%$.
  We propose a method that takes advantage of deviant parameter derivative information while maintaining
  computational efficiency by utilizing mixed-mode differentation.
  Additionally, current QOC techniques mitigate decoherence effects due to longitudinal relaxation by integrating
  the Lindblad master equation, which increases the computational complexity
  of the optimization algorithm. We propose a computationally efficient metric
  and utilize time-optimal control to achieve high fidelity gates in the presence of longitudinal relaxation.
  We apply these techniques to a fluxonium qubit with realisitc experimental constraints
  and noise values. We are able to reduce gate errors by orders of magnitudes in the presence
  of deviant parameters, achieving super-linear scaling for gate robustness as a function of the gate duration.
  We use the same techniques to mitigate coherent errors due to time-varying magnetic flux noise
  by two orders of magnitude. Additionally, we mitigate the gate error arising from longitudinal
  relaxation by a factor of $5$. Further, we find that the numerical techniques we employ
  are able to perform phase gates in arbitrary times, which is critical for operating multi-qubit
  experiments in the lab frame.
\end{abstract}

\maketitle


%% S1
\section{Introduction}
%% textwidth: \printinunitsof{in}\prntlen{\textwidth}
%% linewidth: \printinunitsof{in}\prntlen{\linewidth}
%% P1 - general field, lots of citation. cite reviews, original qoc.
%% P2 - exhaustively find all papers, what people have done to address the issues
%% P3 - what we do is. maybe add a rant about how
%% QOC is classical control theory but we've ignored that field
%% P4 - outline
The field of quantum optimal control (QOC) is concerned
with efficiently and accurately manipulating quantum systems.
Early QOC techniques were proposed for nuclear magnetic resonance experiments
\cite{khaneja2005optimal}, and applications now include superconducting
circuits \cite{heeres2017implementing,
  leng2019robust, leung2017speedup, xu2020nonadiabatic},
neutral and ionized atoms \cite{van2016optimal}, nitrogen-vacancy centers in
diamond \cite{rembold2020introduction}, and Bose-Einstien condensates
\cite{sorensen2018quantum}. QOC techniques are used to
control a system such that a set of optimization objectives are maximally fulfilled.
For quantum computation, relevant objectives include achieving high fidelity
gates and adhering to experimental constraints.
The decision variables of the optimization problem are the time-dependent control
parameters, particular to the quantum system, that govern its evolution.
It is desirable to make the optimization aware of experimental errors
such as noise, system model errors, and control errors, to
improve experimental performance on the optimization objectives.
The field of robust control, deriving from classical control theory, has developed
techniques to account for these errors in optimization (citations appreciated).
In this work we employ robust control techniques to mitigate
releastic decoherence and systematic errors that arise when controlling
a superconducting fluxonium qubit.

Numerical techniques for QOC have been remarkably successful in
state preparation, designing high fidelity gates, and determining
optimized pulse sequences (citations needed). Many popular numerical techniques
are iterative, indirect shooting
methods \cite{leung2017speedup, goer2019krotov, abdelhafez2019gradient,
  machnes2015gradient}.
An initial guess for the control parameters is used to forward-simulate
the quantum state trajectory under the time-dependent Schroedinger equation. Then, gradients
with respect to the controls are computed for an objective evaluated on
the evolved quantum state. The gradients are used to update
the control parameters and the procedure is repeated iteratively.
A convenient way to enforce constraints in this framework is
to employ control filtering or project gradients onto the constraint manifold.
In this work we perform optimization using ALTRO, which combines
an iterative indirect shooting method with the augmented Lagrangian
method \cite{howell2019altro}. The augmented Lagrangian method
allows us to enforce arbitrary, simultaneous constraints and achieve
fast convergence without being restricted to the constraint
manifold.

QOC techniques have been effective in mitigating the effects
of systematic errors. Typically, the model used in optimization
differs from the experimental system due to parameter drift, the inability
to realize control parameters exactly, and noise.
These systematic errors cause the trajectory of the quantum system
in the experiment to deviate from that predicted by the optimization.
A set of controls is said to be robust if the experimental state trajectory
it produces is insensitive to systematic errors.
Considering the dynamical and geometric phases of quantum state
evolution has led to analytic methods for achieving
robustness to dynamical errors and mitigating pure dephasing
\cite{han2020experimental, merrill2014progress, xu2020nonadiabatic, zhang2020universal}.
We mitigate systematic errors numerically by employing
open loop optimization. We draw on robust trajectory optimization
techniques to encode systematic errors in optimization objectives.
We consider three
techniques. The first is the sampling method, which has been applied
previously in the context of QOC
\cite{carvalho2020error, reinhold2019controlling, rembold2020introduction}.
The second is the unscented sampling
method, which derives from the unscented transformation used
for non-linear Kalman filtering
\cite{julier2004unscented, lee2013sigma, manchester2016derivative}.
We propose a third method, which we call the derivative method.
This method takes advantage of derivative information of systematic
errors with respect to the state evolution. We make this method efficient
by employing mixed-mode differentiation.

Further, many analytic and numerical techniques have been developed to mitigate decoherence.
Floquet techniques have been experimentally demonstrated to simultaneously mitigate
decoherence due to longitudinal relaxation and pure dephasing
\cite{huang2020engineering, mundada2020floquet}.
Numerical techniques have mitigated decoherence by evolving the
system using master equations \cite{rembold2020introduction} and employing
Monte Carlo style quantum trajectories \cite{abdelhafez2019gradient}.
In this work we take advantage of the known dependence of the
quantum system's controls on longitudinal relaxation. We encode
the decoherence in an efficient optimization objective that does
not pay the increased computational cost of integrating a master equation.

We compare our techniques using the heavy fluxonium qubit presented in
in \cite{zhang2020universal}. This quantum system is an exciting
platform for quantum computation due to its long longitudinal relaxation
and pure dephasing times at the flux frustation point. This system is also
efficient to simulate due to its accurate two-level approximation.
We emphasize that the numerical techniques we employ extend to arbitrary quantum systems,
not only the one we study here. We describe experimentally realistic constraints for this system
and map them to the ALTRO framework. Next, we
outline a method for making the optimization aware of longitudinal
relaxation. We achieve a factor of 5 increase in longitudinal relaxation times
over the baseline gate set. Then we present three methods for achieving
robustness to systematic errors. We find that we are able to
decrease the gate error arising from systematic errors super-linearly
in the gate duration, achieving orders of magntidue reduction in gate errors.
We also find that the numerical techniques we employ are able to produce
fixed phase gates in arbitrary times, a method that could be used
to control multi-qubit systems in the lab frame. Finally,
we employ the robust control techniques to mitigate time-varying
magnetic flux noise. We achieve a two order of magnitude improvement
in gate errors for extended computations, an improvement critical
for noisy, intermediate-scale quantum (NISQ) applications.


%% S2
\section{QOC + AL-iLQR}
(QOC Problem Statement) Here we introduce the notation
we will use throughout the paper,
review the quantum optimal control problem statement,
and introduce the trajectory optimization framework.
Quantum optimal control concerns the evolution of
a quantum state $\ket{\psi(t)}$ governed by the time-dependent
Schroedinger equation (TDSE)
\label{eq:tdse}
\begin{align}
  i \hbar \frac{d}{dt} \ket{\psi} &= H(u(t), t) \ket{\psi}
\end{align}
The evolution is sometimes cast with the evolution
of a density matrix under the Lindblad master equation to
model the decoherence of the state explicitly. The Hamiltonian
has an arbitrary dependence on the possibly multi-valued controls $u(t)$.
The controls are so called because they are the means the experimentalist has to
act on the system.

Numerical quantum optimal control techniques make
the problem tractable by discretizing the problem into $N$
knot points (time steps). Typical integration techniques for the TDSE include
approximating unitary propagators as well as explicit integration methods,
such as Runge-Kutta, of the form
$\ket{\psi_{k + 1}} \approx \ket{\psi_{k}} + \frac{d}{dt} \ket{\psi_{k}} \cdot \Delta t_{k}$

Quantum optimal control seeks the control
parameters that minimize a functional $J(u(t))$.
In the simplest case the functional is
$J = 1 - {\lvert \braket{\psi_{f} \lvert \psi_{N}(u(t))} \rvert}^{2}$
the infidelity between the inital state evolved
to the final knot point ($\ket{\psi_{N}(u(t))}$)
and the target state ($\ket{\psi_{f}}$). In general
$J$ is a linear combinaion of cost functions on the state, e.g.
forbidden-state occupation, as well as
cost functions on the controls, e.g. the norm of the control amplitudes
\cite{leung2017speedup}. Typical quantum optimal control
algorithms employ automatic differentiation
to compute first order information for the functional ($\nabla_{u} J(u)$).
They employ a first-order optimizer to minimize $J$ with respect to $u$.

(AL-iLQR Problem Statement) The trajectory optimization
literature solves a more general class of non-linear programs that resemble
the quantum optimal control problem. The quantum optimal control
problem is a specific case of the linear quadratic regulator (LQR).
LQR is so called because the dynamics are linear in the state and
the functional is quadratic in the state. In the LQR formulation
the same functional is evaluated at each knot point
\begin{equation}
  J_{\textrm{iLQR}} = \tilde{x}_{N}^{T} Q_{N} \tilde{x}_{N}
  + \sum_{k = 0}^{N - 1} \tilde{x}_{k}^{T} Q_{k} \tilde{x}_{k} + u_{k}^{T} R_{k} u_{k}
\end{equation}
where $\tilde{x}_{k} = x_{k} - x_{f}$ is the difference between the state
at knot point $k$ and final state, $u_{k}$ are the controls,
and $Q_{k}, R_{k}$ are matrices that define the penalty metric.
The state is propagated using a dynamics function
$x_{k + 1} = f(x_{k}, u_{k}, t_{k}, \Delta t_{k})$.
In the case of quantum optimal control $\ket{\psi_{k}} \subseteq x_{k}$
and $f$ encodes the TDSE dynamics. In the following
we refer to $\ket{\psi}$ as the state, $x$ as the augmented
state, and $u$ as the augmented controls.

The advantage of the LQR formulation
is that there exists a dynamic programming algorithm to compute the
optimal update to the augmented controls ($u_{k}$) which minimizes the functional
($J_{\textrm{iLQR}, k}$) for each knot point. This algorithm proceeds by deriving a
recurrence relation between knot points $k$ and $k + 1$ for the optimal
feedback law--known as the Ricatti recursion (see Appendix). The
iterative LQR (iLQR) algorithm computes $J_{\textrm{iLQR}}$
and applies the Ricatti recursion to all knot points on multiple
executions.

In order to incorporate constraints we employ
the augmented Lagrangian method. Constraints are contributions
to the functional of arbitrary form $c_{k}(x_{k}, u_{k})$ which are
zero or negative when the constraint is satisfied. The AL-iLQR
method associates a penalty multiplier with the functional
that estimates the constraint's Lagrange multiplier.
The algorithm updates the penalty multiplier between
iLQR executions. In this scheme the functional takes the form
\begin{equation}
  \begin{aligned}
    J_{\textrm{AL-iLQR}} = \ &(\lambda_{k} + \frac{1}{2}I_{\mu_{k}} c_{k}(x_{k}, u_{k}))^{T} c_{k}(x_{k}, u_{k})\\
    &+ J_{\textrm{iLQR}}
  \end{aligned}
\end{equation}
where $\lambda_{k}$ is a Lagrange multiplier and $I_{\mu_{k}}$ is a penalty matrix
with $\mu_{k}$ along the diagonal.
$\lambda_{k}$ and $\mu_{k}$ are updated after each augmented Lagrangian iteration according to
\begin{align}
  \lambda_{k_{i}} &\gets \max(0, \lambda_{k_{i}} + \mu_{k_{i}} c_{k_{i}}(x_{k}^{*}, u_{k}^{*}))\\
  \mu_{k_{i}} &\gets \phi \mu_{k_{i}}
\end{align}
where $x^{*}, u^{*}$ are the optimal augmented state and augmented controls from the iLQR execution,
$i$ indicates the $i$-th constraint functional,
and $\phi$ is a hyperparameter. With this updated form of the cost
functional there still exists a recurrence relation to calculate the optimal control
updates, see \cite{howell2019altro}.


%% S3
\section{QOC on the Fluxonium}
In the following we study
the quantum optimal control problem on the fluxonium qubit.
The fluxonium qubit is a promising building block for superconducting
circuits, and the experimental constraints we encode in the optimization reflect
those of a realistic device. Furthermore, the accurate
two-level approximation of the system Hamiltonian makes it
efficient to perform quantum optimal control on
a classical computer. In the two-level
approximation the system Hamiltonian takes the form
\label{eq:hamiltonian}
\begin{align}
  H/h &= f_{q} \frac{\sigma_{z}}{2} + a(t) \frac{\sigma_{x}}{2}
\end{align}
where $f_{q} = 14$MHz is the qubit frequency at the flux frustration point,
$a$ is the flux drive amplitude, $h$ is Planck's constant, and $\sigma_{x}, \sigma_{y}$
are Pauli matrices. The flux amplitude $a$ is experimentally
realized by modulating the flux 
threading the device. We consider the task of constructing $Z/2$, $Y/2$, and $X/2$
gates for the fluxonium qubit subject to experimental constraints, decoherence, and
systematic errors. We compare the gates we obtain with numerical
methods to the analytically constructed gates reported in
\cite{zhang2020universal} for the same device.

In addition to imposing optimization constraints that
reflect physical limitations of the apparatus, we impose
constraints that improve the experimental realization of the control pulse.
To ensures gates may be concatenated arbitrarily without
inducing AWG ringing due to high-frequency transitions,
we require $a(t = 0) = a(t = t_{N}) = 0$.
Furthermore, we require $\int_{0}^{t_{N}} a(t) dt = 0$. This
constraint ensures the pulse has zero net flux, mitigating
the hysteresis ubiquitous in flux bias lines.
%% TODO: See ref. 28 in Helin paper
We require $-0.5 \textrm{GHz} \le a(t) \le 0.5 \textrm{GHz}$
to ensure the two-level approximation \ref{eq:hamiltonian}
remains valid. Additionally, we require that each gate achieves
the desired state transition $\ket{\psi_{N}} = \ket{\psi_{f}}$.
In addition to these constraints we penalize the norm
of the first and second derivatives of the flux amplitude to
ensure its smoothness, and in doing so mitigate AWG ringing.

The optimization is performed over the second derivative of the flux amplitude
$\frac{d^{2}}{dt^{2}} a$ which is contained in the
augmented control vector. The first derivative
$\frac{d}{dt} a$, proportional $a$, and integral $\int a$
flux amplitude terms
are contained in the augmented state vector. They are obtained from
the second derivative of the flux amplitude by
integration in the dynamics function.
Both the zero net flux and target quantum state constraint
are then handled by ensuring the target augmented state is
reached $x_{N} = x_{f}$.
The equality and inequality constraints on $a$ are handled
with a bound constraint.
%% TODO: probably want to list equations for the constraints

In addition to obeying experimental constraints
and achieving low simulated gate errors, we desire
to make our gates perform well in the presence of decoherence.
Decoherence of the quantum state due to external noise
is typically modeled by two phenomena: longitudinal relaxation and pure dephasing.
They are modeled using their $1/e$ decay times $T_{1}$ and $T_{\phi}$ respectively
(see Appendix).
The main contributions to longitudinal relaxation in our
device are dielectric loss in the capacitor, resistive loss in the inductor,
and Purcell loss. The main contributions to pure dephasing in our
device are $1/f$ flux noise and decay via charge and flux coupling
to the control lines.

Dissipation to the thermal bath via longitudinal
relaxation is an irreversible process
that results in information loss.
Converesely, pure dephasing is a reversible process.
There is a tradeoff between the two decoherence processes. In the case of white
noise the sum of the noise weights $W_{1}$ and $W_{\phi}$
is constant \cite{huang2020engineering}.
Our device achieves its best pure dephasing
protection at the flux frustration point
$T_{2e}(a = 0) \sim 300 \mu\textrm{s}$
where the qubit is first-order insensitive to changes in flux.
It becomes more succeptable to pure dephasing as the flux is tuned away from the flux
frustration point $|a| > 0$. Conversely, longitudinal relaxation is at a minimum
at the flux frustration point $T_{1}(a = 0) = 0.315$ms,
and increases away from the flux frustration point
$T_{1}(a = 0.34 \textrm{GHz}) = 4.3$ms. Given the nature
of the decay processes and the tradeoff, we choose
to maximize the longitudinal relaxation time directly
via the flux amplitude and employ robust control techniques to mitigate
pure dephasing.

%% TODO: talk about quadratic cost vs. infidelity

%% F1
\begin{figure*}[ht]
  \begin{subfigure}{.315\textwidth}
    \includegraphics[width=\linewidth]{assets/f1a.png}
  \end{subfigure}\hfill
  \begin{subfigure}{.23\textwidth}
    \includegraphics[width=\linewidth]{assets/f1b.png}
  \end{subfigure}\hfill
  \begin{subfigure}{.4\textwidth}
    \includegraphics[width=\linewidth]{assets/f1c.png}
  \end{subfigure}
  \caption{
    (a) $T_{1}$ optimized gates (red) and analytic gates (blue).
    (b) $T_{1}$ interpolation function used in optimization. Markers
    denote the time-averaged, absolute amplitude of each gate.
    (c) Lindblad master equation simulation with $T_{1}$ dissipation
    for successive gate applications. The reported gate error is the cumulative
    gate error after each gate application.
    The $T_{1}$ optimized $Z/2$ and $Y/2$ gate errors are indistinguishable
    in the figure.
  }
\end{figure*}

%% S4
\section{Longitudinal Relaxation Awareness}
The longitudinal relaxation time $T_{1}$ varies with
control parameters in a range of superconducting circuit platforms.
It is advantageous to tune the controls to extend the longitudinal
relaxation time.
To calculate the gate error due to longitudinal relaxation
requires propagating density matrices of size $n \times n$ under Master equation
dynamics, rather than state vectors of size $n$ under the TDSE dynamics.
We avoid this increase in computational complexity by
penalizing the integrated rate of longitudinal relaxation,
i.e. the probability of longitudinal relaxation.
Using this probability as proxy for the gate error incurred
is reasonable because losses due to longitudinal relaxation
increase monotonically in time.
This technique can be extended to
error channels which share the monotonically increasing property.
Additionally, for a constant $T_{1}$ time, a shorter gate duration
would favor a lower longitudinal relaxation probability. We allow
the optimizer to tune the gate duration in order to minimize the
longitudinal relaxation probability. Our scheme for time-optimal
control is applicable to any time-optimal problem, not only
the one we study here.

The longitudinal relaxation probability is given by
\begin{equation}
  P_{1}(t) = \int_{0}^{t} T_{1}^{-1}(a(t^{\prime})) dt^{\prime}
\end{equation}
$P_{1}$ is penalized using a quadratic cost at each knot point
${\lvert P_{1}(t_{k}) \rvert}^{2}$.
$T_{1}(a_{k})$ is obtained at each knot point by evaluating
a spline fit to experimental data of the form $\{(a, T_{1})\}$.
It is also possible to use a spline fit to theoretically obtained data.
However, $T_{1}$ values are known to fluctuate greatly
with laboratory temperatures \cite{klimov2018fluctuations}.
Interpolating $T_{1}$ from experimental data
increases the fridge truth of the simulation.

We allow the optimizer to tune the gate duration by
making the time step between each knot point $\Delta t_{k}$
a decision variable. Promoting $\Delta t_{k}$ to a decision variable, rather
than the number of knot points $N$, preserves the
Markovian decision structure of the trajectory
optimization problem. To ensure numerical
integration accuracy is maintained we add a bound
constraint at each knot point
$5\textrm{e-}2 \ \textrm{ns} \le
\Delta t_{k} \le 2\textrm{e-}1 \ \textrm{ns}$.
This bound constraint may be
violated for intermediate iterations of the optimization,
so we add the square root of the time step $\sqrt{\Delta t_{k}}$
to the augmented control vector and use the squared root
of the time step $\lvert \Delta t_{k} \rvert$ in optimization.

We compare the numerical method we have developed to the analytic gates
on the task of achieving low gate errors in the presence of longitudinal relaxation
for the $Z/2$, $Y/2$, and $X/2$ gates.
The numerically optimized gates converge on similar solutions, a periodic
waveform with amplitude $\sim 0.2 \textrm{GHz}$, see Figure 1.
They extend their gate times
beyond their analytic counterparts, trading longer gate times for access
to higher amplitudes and therefore higher $T_{1}$ times. All optimized gates reduce
their single gate errors by a factor of $5$ over
their analytic counterparts which is commensurate to their
probability of longitudinal relaxation reductions, see Appendix.
The gate error reported in this text is the infidelity
of the evolved state and the target state averaged over 1000 pseudo-randomly
generated initial states. The optimized $Z/2$ and $Y/2$ gates perform simlarly in
the concatenated gate application comparision, suppressing accumulated gate errors to $8 \cdot 10^{-3}$
over $2000$ gate applications $\sim 40 \mu\textrm{s}$. The optimized $X/2$ gate
achieves an accumulated gate error of $1.7 \cdot 10^{-2}$ over $2000$ gate applications $\sim 124 \mu\textrm{s}$.
Both the analytic and optimized gates attain single gate errors sufficient for
quantum error correction $< 10^{-4}$, requisite for fault-tolerant quantum computing.
The low gate errors achieved by the optimized gates for extend computations
are critical for noisy, intermediate-scale quantum (NISQ) applications.
These improvements are significant for the realistic constraints we have imposed
on the gates, and do not represent a fundamental limit to the optimization methods we have
employed.

%% F2
\begin{figure*}[ht]
  \begin{subfigure}{.315\textwidth}
    \includegraphics[width=\linewidth]{assets/f2a.png}
  \end{subfigure}\hfill
  \begin{subfigure}{.4\textwidth}
    \includegraphics[width=\linewidth]{assets/f2c.png}
  \end{subfigure}\hfill
  \begin{subfigure}{.23\textwidth}
    \includegraphics[width=\linewidth]{assets/f2b.png}
  \end{subfigure}
  
  \caption{
    (a) $Z/2$ gates robust to qubit frequency detunings constructed with the
    analytic, sampling, unscented sampling, and the 1\textsuperscript{st}-
    and 2\textsuperscript{nd}-order derivative methods. The gates
    shown for the numerical methods are the solutions at twice the analytic
    gate time.
    (b) Single gate error as
    a function of the gate duration at a one-percent
    detuning from the nominal qubit frequency for all methods. Missing
    data points represent solutions with a gate error above $5 \cdot 10^{-5}$.
    (c) Single gate error as a function of the detuning from the nominal
    qubit frequency. The solutions for the analytic and
    1\textsuperscript{st}-order derivative methods are shown at multiples
    of the analytic gate time. The performance of the two methods is
    indistinguishable at the analytic gate time $18$ns.
  }
\end{figure*}

%% S5
\section{Robustness to Static Parameter Deviations}
We have formulated the quantum optimal control
problem as an open loop optimization problem, i.e.
feedback from the experiment is not incorporated in optimization.
However, the device typically deviates from the Hamiltonian we use in optimization,
leading to poor experimental performance. To mitigate
these errors we employ robust control techniques
to make the state evolution insensitive to Hamiltonian
parameter deviations. As an example
we mitigate errors arising from the drift and finite measurement
precision of the qubit frequency $\tilde{f_{q}} = f_{q} \pm \sigma_{f_{q}}$.
We consider three robust control techniques.
The first is the sampling method, which has
been preposed previously in the context of QOC
\cite{rembold2020introduction, reinhold2019controlling, carvalho2020error}. In the
sampling method, multiple states are evolved under distinct deviant dynamics
to capture the effect of parameter deviations. We also
study the unscented sampling method which uses the unscented
transformation to accurately propagate a distribution
representing the uncertainty in an evolving state
due to a parameter deviation.
The unscented transformation was designed for nonlinear Kalman
filtering and is frequently utilized in robust control
\cite{julier2004unscented, lee2013sigma, manchester2016derivative}.
Finally, we propose the derivative method. Derivative
information encoding the sensitivity of the
state trajectory with respect to the deviant parameter
is used to penalize state trajectory deviations.

In the sampling method, sample states evolve under a
Hamiltonian where a parameter is replaced by
a deviant value. We propagate the additional states $\ket{\psi^{\pm}}$ with
deviant values $\lambda^{\pm} = \lambda \pm \sigma_{\lambda}$.
The gate error of each sample state is 
penalized at each knot point
$1 - {\lvert \braket{\psi^{\pm}_{k} | \psi_{f}} \rvert}^{2}$.
Each initial state is used to initialize two
sample states $\ket{\psi^{\pm}}$.
The initial states are chosen so
that their outer products span the operators on the
Hilbert space $\{\ket{0}, \ket{1}, (\ket{0} + i\ket{1}) / \sqrt{2},
(\ket{0} - \ket{1}) / \sqrt{2}\}$ \cite{chow2009randomized}.
For this method the number of states in the augmented state vector
scales as $O(dn^{2})$ because each of $n^{2}$ initial
states is represented by $2d$ samples. $n$ is both the dimension of the Hilbert space
and the size of the state vector. $d$ is the number of deviant parameters.

%% F3
\begin{figure*}[ht]
  \begin{subfigure}{.4\textwidth}
    \includegraphics[width=\linewidth]{assets/f3a.png}
  \end{subfigure}\hspace{0.025\textwidth}
  \begin{subfigure}{.4\textwidth}
    \includegraphics[width=\linewidth]{assets/f3b.png}
  \end{subfigure}

  \caption{
    (a) $X/2$ gates robust to flux offsets constructed with the analytic,
    sampling, unscented sampling, and the 1\textsuperscript{st}-
    and 2\textsuperscript{nd}-order derivative methods. The gates shown
    are the solutions at the analytic gate time.
    (b) Simulation of stochastic 1/$f$ flux noise for
    successive gate applications. The reported gate error is the cumulative
    gate error after each gate application.
  }
\end{figure*}

The strategy of the unscented sampling method is to
propagate an ensemble of sample states (sigma points) which represent a distribution
over every element of the initial state. The distribution
models the uncertainty in each state element arising from the
parameter deviation. The ensemble consists of $2 (n + d)$ states.
Each state in the
ensemble is propagated to the next
knot point using separate deviant dynamics. Then, the mean and covariance of
the propagated ensemble is calculated. New states are sampled from the distribution
given by the calculated statistics for propagation to the next knot point.
This resampling procedure, the unscented transformation, accurately propagates
first and second moments of the distribution and ensures the points
lie on the $\sqrt{n}$\textsuperscript{th}
covariance contour at each knot point. A detailed update procedure is given
in the appendix. Each initial state from the operator basis
is represented with a distribution of $2 (n + d)$ samples. Hence,
the number of states in the augmented state vector scales as $O(n^{3} + dn^{2})$.
The gate error of each sample state is penalized as in the sampling method.

The derivative method draws on the intuition that
the sensitivity of the state evolution to a parameter
$\lambda$ is encoded in the $l$\textsuperscript{th}-order
derivative of the state with respect to that parameter
$\ket{\partial_{\lambda}^{l} \psi}$. The $m$\textsuperscript{th}-order
derivative method minimizes the norm of the first $m$
state derivatives with a quadratic cost at each knot point
${\lvert \braket{\partial^{l}_{\lambda} \psi | \partial^{l}_{\lambda} \psi}
  \rvert}^{2}$, $l \in \{1, \dots, m\}$.
The state derivatives could be obtained with backwards mode differentiation.
Naive automatic differentiation would compute
the state derivative at all $1, \dots, k - 1$ knot points
to obtain the state derivative at knot point $k$.
For a single state derivative and $N$ knot points this
requires $O(N^2)$ matrix multiplications.
Instead, we forward propagate the state derivatives in the
augmented state vector under coupled dynamics, resulting in
$O(N)$ matrix multiplications. For example, the dynamics
for the 1\textsuperscript{st}-order derivative method are
\begin{align}
  i \hbar \frac{d}{dt} \ket{\psi} &= H \ket{\psi}\\
  i \hbar \frac{d}{dt} \ket{\partial_{\lambda}\psi} &=
  H \ket{\partial_{\lambda} \psi} +
  (\partial_{\lambda} H) \ket{\psi}
\end{align}
Exponential integrators that account for the non-linear
term may be used to efficiently integrate the coupled dynamics
\cite{berland2005solving, einkemmer2017performance}.
For this method $m$ state derivatives are associated with each
initial state from the operator basis.
So, the number of states in the augmented state vector scales as
$O(dmn^{2})$.

To demonstrate the applicability of these techniques
to mitigate system parameter deviations,
we consider the task of achieving a single $Z/2$
gate subject to a constant qubit frequency detuning
$f_{q} \gets f_{q} + \delta f_{q}$.
We take $\sigma_{f_{q}} / f_{q} = 1\%$ to be one standard devation, and equip
the sampling methods accordingly. For each method we compute the gate error for
one simulated gate application subject to the deviant dynamics given by the
stated qubit frequency detuning $\delta f_{q}$.

We compare the numerical methods
to an analytically derived $Z/2$ gate. This gate corresponds to
idling at the flux frustration point $a = 0$. The analytic gate
is at the device's speed limit for a $Z/2$ gate $t_{Z/2} = 1 / 4 f_{q}$ and
is simple to derive. Its erroneous rotation angle $2 \pi t_{Z/2} \delta f_{q}$ is linearly sensitive to
the qubit frequency detuning, resulting in a gate error that is quadratically sensitive
to the qubit frequency detutning.
At a one-percent
qubit frequency detuning the analytic gate achieves a gate error $\sim 4.5 \cdot 10^{-5}$,
which is sufficient for quantum error correction, see Figure 2b.
Although the analytic $Z/2$ gate performs well, it works
only at the gate time $t_{Z/2}$. The ability to perform $Z$ rotations in arbitrary times is critical
for operating multi-qubit experiments in the lab frame.
Each numerical method is able to find solutions at
all gate times above $t_{Z/2}$, but is unable to find solutions at shorter times,
see Figure 2b. These numerical methods offer an effective scheme for synchronizing
qubits operating at different frequencies $f_{q, i} \neq f_{q, j}$.

%% TOOD: intro sentence
%% TODO: comment on unscented when it is redone
The sampling and unscented sampling methods
converge on qualitatively similar solutions which combine idling periods
with fast ramps to the maximum amplitude. The gate error at a one-percent
detuning from the nominal qubit frequency achieved
by the sampling method does not improve substantially over the
range of gate durations. The unscented sampling method
achieves linear decreases in its gate error with longer gate durations
until half the larmor period $1 / 2 f_{q}$ after which it achieves a consistent
gate error $\sim 3.5 \cdot 10^{-5}$.
The derivative methods converge on qualitatively similar solutions that
use fast traingle pulses at the boundaries and balance time
on either side of the flux-frustration point symmetrically at low amplitudes.
Both methods achieve a super-linear scaling in their gate error as
a function of the gate duration. The gate error for the 1\textsuperscript{st}-order
derivative method approaches zero at the larmor period $1 / f_{q}$.
We believe the 1\textsuperscript{st}-order method outperforms the \textsuperscript{nd}-order
method due to the low contribution of second-order
terms to the gate error in this deviation regime, see Table 2.

%% TODO: comment on the fact that we can reduce the number of sample states
%% TODO: how do I tie this in?
Multiple analytic methods have also been presented to construct gates
that mitigate the error arising from parameter deviations
including composite pulse sequences \cite{merrill2014progress},
the DRAG scheme \cite{krantz2019quantum}, and
geometric phase considerations
\cite{xu2020nonadiabatic, han2020experimental}.
Composite pulse sequences are derived by computing
the erroneous rotation arising from the static parameter deviation
with a finite order magnus expansion.
Pulses are then suitably composed to eliminate the
error. In principle the error may be eliminated
to arbitrary order with sufficiently many pulses.
It is difficult to choose an appropriate composite pulse
for comparison on the problem we study here. We
propose comparing numerical methods to existing analytic
techniques for future work.


%% S6
\section{Robustness to Stochastic Parameter Deviations}
An additional source of experimental error arises from stochastic
Hamiltonian parameter deviations. For many flux-biased and inductively-coupled
superconducting circuit elements, magnetic flux noise is a significant
source of coherent errors. Magnetic flux noise
modifies the fluxonium qubit's amplitude from its nominal value by an amount $\delta a$.
It is well studied that the spectral density of $\delta a$ follows a
1/$f$ distribution for a range of devices, consisting primarily of low frequency
noise (citations needed). Analytic methods to combat 1/$f$ noise
take advantage of the low frequency characteristic and
treat the noise as quasi-static, performing generalizations of the spin-echo technique
to compensate for erroneous drift. This is the strategy employed by the analytic gate
considered here.

We compare the numerical methods discussed in the previous section
on the task of realizing a $X/2$ gate subject to 1/$f$ flux noise.
The noise is generated by
filtering white noise sampled from a standard normal distribution using a finite
impulse response filter. It is then scaled by the 
flux noise amplitude of our device $A_{\Phi} = 5.21 \mu \Phi_{0} \implies
\delta a \sim 2.5 \cdot 10^{-5} \textrm{GHz}$.
The unscented sampling method is modified so that its sampled deviations
follow a 1/$f$ distribution by carrying the state of a finite impulse response filter
in the augmented state vector. In principle the basic sampling method could be modified
similarly but we choose to sample statically at $\delta a$ for comparision. The derivative
methods require no modification from the static case.

We simulate successive applications of the gate constructed by each method and compute the gate error
after each application, see Figure 3. Both the analytic and numerical methods achieve single gate errors
sufficient for quantum error correction. Despite converging on qualitatively different solutions, the
numerical methods perform similarly in the concatenated gate application comparision, achieving a two
order of magnitude reduction in gate error over the analytic gate at $200$
gate applications $\sim 11 \mu\textrm{s}$.
Coherent errors are a signficiant source of error in NISQ applications and these numerical techniques give
an effective method for mitigating them.

%% S7
\section{Conclusion}
We have proposed some schemes and they work well.


%% ACK
\begin{acknowledgments}
  The authors would like to thank Helin Zhang for experimental assistance
  and Daniel Weiss for useful discussions.
\end{acknowledgments}


\appendix
%% AA
\section{Ricatti Recursion}
This will give the reader unfamiliar with trajectory
optimization intuition for how the trajectory optimization
update scheme works and why it is better than
a more naive method.


%% AB
\section{Experiment}
We measure $T_{1}$ using the standard experiment
and $T_{2}$ using te Ramsey experiment. We fit with splines
and the data looks like fig. 3 in Helin's paper \cite{zhang2020universal}.
We measure $f_{q}$ and $\sigma_{f_{q}}$ using X method.


%% AC
\section{Dissipation}
We model dissipation using the Lindblad master
equation. 
\begin{equation}
  \frac{d}{dt} \rho = \frac{-i}{\hbar} [H, \rho] + \sum_{i = 1}^{N^{2} - 1} \gamma_{i} (L_{i} \rho L_{i}^{\dagger} - \frac{1}{2} \{L_{i}^{\dagger} L_{i}, \rho\})
\end{equation}
where $\rho = \ket{\psi}\bra{\psi}$ is the density matrix, $N = \textrm{dim}(\mathcal{H})$,
and $[\cdot, \cdot], \{\cdot, \cdot \}$ are the algebraic commutator and anti-commutator.
For longitudinal relaxation $\gamma_{1} = T_{1}^{-1} = T_{1, \uparrow}^{-1} + T_{1, \downarrow}^{-1}$
and $L_{\uparrow} = \sigma^{+}/2$,
$L_{\downarrow} = \sigma^{-}/2$
are the ladder operators $\sigma^{\pm} = \sigma_{x} \pm i \sigma_{y}$. For pure dephasing
$\gamma_{2} = T_{2}^{-1} = (2 T_{1})^{-1} + T_{\phi}^{-1}$ and
$L_{2} = (I - \sigma_{z})/2$.

%% T1
\begin{table}[ht]
  \begin{tabular}{c | c | c | c | c | c | c}
         & Analytic & QOC & & Analytic & QOC & \\
    Gate & $P_{1}\ (10^{-5})$ & $P_{1}\ (10^{-5})$ & $P_{1\textrm{A}} / P_{1\textrm{Q}}$
    & GE $(10^{-5})$ & GE $(10^{-5})$ & GE$_{\textrm{A}}$ / GE$_{\textrm{Q}}$\\
    \hline
    Z/2 & 5.745  & 1.149 & 5.000 & 1.776 & 0.371 & 4.787\\
    Y/2 & 5.253  & 1.157 & 4.540 & 1.539 & 0.370 & 4.159\\
    X/2 & 16.251 & 2.660 & 6.109 & 5.347 & 0.863 & 6.196\\
  \end{tabular}
  \caption{Probability of longitudinal relaxation for each gate
    evaluated at the gate's duration.}
\end{table}

%% AD
\section{Derivative Method}
To obtain the dynamics for the derivative of the state $\partial_{x}^{l} \ket{\psi(t)}$
we differentiate the TDSE dynamics \ref{eq:tdse} with respect to the parameter of interest
($x$). Using the fluxonium hamiltonian \ref{eq:hamiltonian} we obtain the derivative of the
state with respect to the qubit frequency ($f_{q}$) and the flux amplitude ($a$).
Here we present the dynamics for the second derivative of the state with respect to the
qubit frequency. The case is analogous for the flux amplitude. Both $H$ and $\ket{\psi}$ are functions
of $f_{q}$, $a$, and $t$, but we omit the explicit dependence in notation for
brevity.
\begin{equation}
  \begin{aligned}
      \partial_{f_{q}} \partial_{t} \ket{\psi} &= \partial_{f_{q}} H \ket{\psi}\\
      &= (\partial_{f_{q}} H) \ket{\psi} + H (\partial_{f_{q}} \ket{\psi})\\
      &= \frac{\sigma_{z}}{2} \ket{\psi} + H (\partial_{f_{q}} \ket{\psi})
  \end{aligned}
\end{equation}
\begin{equation}
  \begin{aligned}
    \partial_{f_{q}}^{2} \partial_{t} \ket{\psi} &= \partial_{f_{q}} (\partial_{f_{q}} H \ket{\psi})\\
    &= (\partial_{f_{q}}^{2} H) \ket{\psi} + 2 (\partial_{f_{q}} H)(\partial_{f_{q}} \ket{\psi})\\
    &\quad + H (\partial_{f_{q}}^{2} \ket{\psi})\\
    &= \sigma_{z} (\partial_{f_{q}} \ket{\psi}) + H (\partial_{f_{q}}^{2} \ket{\psi})
  \end{aligned}
\end{equation}
The augmented state vector carries $\partial_{f_{q}}^{l} \ket{\psi}$
which appears explicitly in its own dynamics. Due to the dependence of $H$ on $f_{q}$ and $a$,
the $l$\textsuperscript{th} state derivative is coupled to the
$l - 1$\textsuperscript{th} state derivative.

%% T2
\begin{table}
  \begin{tabular}{c | c | c}
    Method & ${\lvert \ket{\partial_{f_{q}} \psi_{N}} \rvert}^{2}$ ($10^{3}$)
    & ${\lvert \ket{\partial^{2}_{f_{q}} \psi_{N}} \rvert}^{2}$ ($10^{7}$)\\
    \hline
    D-1 & 2.051 & 17.935\\
    D-2 & 2.511 & 7.628\\
  \end{tabular}
  \caption{Norm of the first basis state's derivate with respect to the qubit frequency
    for $Z/2$ gates optimized using the derivative methods. The norms are computed
    at the end of the gate's duration $t_{N} = 38$ns.}
\end{table}


%% AE
\section{Complex Tensor Handling}
We use an isomorphism $\mathcal{H}(\mathbb{C}^{n}) \cong \mathcal{H}(\mathbb{R}^{2n})$
because the software we use does not support complex numbers yet.


\bibliography{refs}

\end{document}
