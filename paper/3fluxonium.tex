\section{QOC for the Fluxonium \label{sec:fluxonium}}
In the following, we optimize quantum gates
for the superconducting fluxonium qubit -- a promising
building block for quantum computers due to its high
coherence times
\cite{earnest2018realization, lin2018demonstration,
  manucharyan2009fluxonium, somoroff2021millisecond, nguyen2019high,
  zhang2020universal}.
In this section, we use the trajectory optimization
formalism \eqref{eq:gcostfun}-\eqref{eq:eqcon}
to define the optimization problem \eqref{eq:costfun}-\eqref{eq:ic_con},
which we extend in subsequent sections to account
for experimental error channels.
To high accuracy, we approximate the fluxonium Hamiltonian near the flux-frustration
point as a two-level system:
\begin{align}
  H/h &= f_{q} \frac{\sigma_{z}}{2} + a(t) \frac{\sigma_{x}}{2}.
  \label{eq:hamiltonian}
\end{align}
Here, $f_{q}$ is the qubit frequency at the flux-frustration point,
$a(t)$ is the control governing the flux offset from the flux-frustration point,
$h$ is Planck's constant, and $\sigma_{z}, \sigma_{x}$
are Pauli matrices. Although the coherent dynamics can be described with this two-level
system model, our noise model, experimental constraints, and system parameters
consider the full system, and they are representative of the fluxonium
presented in \cite{zhang2020universal}.

First, we introduce the augmented control and state for the fluxonium gate problem.
Since the ALTRO implementation we use does not currently
support complex numbers, we represent the quantum states
in the isomorphism $\mathcal{H}(\mathbb{C}^{n})
\cong \mathcal{H}(\mathbb{R}^{2n})$ given in \cite{leung2017speedup},
\begin{equation}
  H \ket{\psi} \cong \begin{pmatrix} H_{\textrm{re}} & -H_{\textrm{im}}
    \\ H_{\textrm{im}} & H_{\textrm{re}}\end{pmatrix}
  \begin{pmatrix} \ket{\psi}_{\textrm{re}} \\ \ket{\psi}_{\textrm{im}}\end{pmatrix}.
  \label{eq:isomorphism}
\end{equation}
We use $\psi$ -- abandoning bra-ket notation -- to denote the real representation of a state
given by the right-hand-side of \eqref{eq:isomorphism}.
To refer to the discrete moments of the flux, we introduce the notation
$\int_{t} a_{k} \equiv \int^{t_{k}}_{t_{1}} a(t) \ \mathrm{d}t$,
$a_{k} \equiv a(t_{k})$,
$\mathrm{d}^{n}_{t} a_{k} \equiv \mathrm{d}^{n}a(t)/{\mathrm{d}t}^{n} \lvert_{t = t_{k}}$.
The augmented control and state are:
\begin{equation}
  \begingroup
  \renewcommand*{\arraystretch}{1.3}
  \mathbf{u}_{k} = \begin{pmatrix} \mathrm{d}^{2}_{t} a_{k} \end{pmatrix}, \quad
  \mathbf{x}_{k} = \begin{pmatrix} \psi^{0}_{k} \\ \psi^{1}_{k}
    \\ \int_{t} a_{k} \\ a_{k} \\ \mathrm{d}_{t} a_{k} \end{pmatrix}.
  \endgroup
  \label{eq:astatecontrols}
\end{equation}
Here, the superscript on the quantum states $i \in \{0, 1\}$ acts as a label.
In standard QOC frameworks, the derivatives of the control fields
are obtained with finite difference methods, e.g.,
$\mathrm{d}_{t} a_{k} \approx (a_{k + 1} - a_{k}) / \Delta t$ \cite{leung2017speedup}.
Because ALTRO requires that cost functions do not use information from multiple time steps,
we make $\mathrm{d}^{2}_{t} a_{k}$ a decision variable and
numerically integrate coupled ODEs to obtain $\mathrm{d}_{t} a_{k}$, $a_{k}$, and $\int_{t} a_{k}$
so that we may penalize them in cost functions.
Similarly, the quantum states are obtained by numerically integrating
the TDSE \eqref{eq:tdse} with the fluxonium Hamiltonian \eqref{eq:hamiltonian}
and the given flux $a_{k}$. These numerical integration rules are implemented
in the discrete dynamics function for the problem, and they give rise to the
dynamics constraint \eqref{eq:dyn_con}.

Next, we outline the constraints for this problem.
Casting this problem in terms of a multi-state transfer problem, we fix as the initial states
 $\ket*{\psi^{0}_{1}} = \ket*{0}$, $\ket*{\psi^{1}_{1}} = \ket*{1}$
\eqref{eq:istate_con}.
The states at the final time step are constrained to be
the target states $\ket*{\psi^{i}_{N}} = \ket*{\psi^{i}_{T}} \equiv
U \ket*{\psi^{i}_{1}} \ \forall \ i$
\eqref{eq:tstate_con} where $U = X/2, Y/2, Z/2$ denotes the target gate.
Furthermore, we impose the normalization constraint
${\lvert \braket*{\psi^{i}_{k}}{\psi^{i}_{k}} \rvert}^{2} = 1 \ \forall \ i,k$
\eqref{eq:statenorm_con}
to ensure the solver does not take advantage of discretization errors in numerical integration.
For the flux moments,
we have the initial condition $\int_{t} a_{1} = \mathrm{d}_{t} a_{1} = 0$
\eqref{eq:ic_con}.
We also enforce the boundary condition $a_{1} = a_{N} = 0$ \eqref{eq:ic_con}, \eqref{eq:znf_con}
so the gates may be concatenated arbitrarily. 
We impose the zero net-flux constraint $\int_{t} a_{N} = 0$
\eqref{eq:znf_con}
which mitigates the inductive drift ubiquitous in flux-bias lines
\cite{battistel2019fast, krantz2019quantum, zhang2020universal}.
Additionally, the flux is constrained by $\lvert a_{k} \rvert \leq 0.5 \ \textrm{GHz}
\ \forall \ k$ \eqref{eq:amp_con} to ensure the two-level approximation
\eqref{eq:hamiltonian} remains valid. Above $0.5$ GHz,
we experimentally observe that the relationship
between the energy levels and the flux becomes strongly non-linear.
All gates presented in this work satisfy these constraints to
a maximum violation of $\sim 10^{-8}$.

The cost function at each time step is
$\ell_{k}(\mathbf{x}_{k}, \mathbf{u}_{k}) = (\mathbf{x}_{k}
- \mathbf{x}_{T})^{T} Q_{k} (\mathbf{x}_{k} - \mathbf{x}_{T})
+ \mathbf{u}^{T}_{k} R_{k} \mathbf{u}_{k}$
where $Q_{k}$ and $R_{k}$ are diagonal matrices
of hyperparameters that assign weights to cost function contributions.
The $Q_{k}$ term
penalizes deviations from the target augmented state
$\mathbf{x}_{T} = (\psi^{0}_{T}, \psi^{1}_{T}, 0, 0, 0)^{T}$,
which is consistent with the constraints we have
imposed on $\ket*{\psi^{i}_{N}}$, $\int_{t} a_{N}$, and $a_{N}$.
Accordingly, this term penalizes the squared
difference of $\psi^{i}_{k}$ and $\psi^{i}_{T}$
and penalizes the norm of $\int_{t} a_{k}$, $a_{k}$, and $\mathrm{d}_{t} a_{k}$.
We penalize the squared difference of the final and target
quantum states, rather than their infidelities,
because the Hessian of the squared-difference cost function is diagonal -- which
makes matrix multiplications fast -- and we wish to optimize $Z/2$ gates,
which requires a metric that is sensitive to global phases for the initial
states $\ket*{0}$ and $\ket*{1}$.
Additionally, the $R_{k}$ term penalizes the norm of $\mathrm{d}^{2}_{t} a_{k}$.
Penalizing the norm of $\mathrm{d}^{2}_{t} a_{k}$ and $\mathrm{d}_{t} a_{k}$
makes $a_{k}$ smooth, which mitigates high-frequency AWG transitions.
Stated succinctly, the optimization problem takes the form:
\begin{mini!}[2] 
  {\substack{\mathbf{x}_1,\ldots,\mathbf{x}_N \\ \mathbf{u}_1,\ldots,\mathbf{u}_{N-1}}}
  {\sum_{k=1}^N {(\mathbf{x}_k-\mathbf{x}_{T})}^{T} Q_k (\mathbf{x}_k-\mathbf{x}_{T})
    + \sum_{k=1}^{N-1} {\mathbf{u}_k}^{T} R_k \mathbf{u}_{k}}{}{} \label{eq:costfun}
  \addConstraint{\mathbf{x}_{k+1}}{= \mathbf{f}(\mathbf{x}_k, \mathbf{u}_k) \ \forall \ k}
  \label{eq:dyn_con}
  \addConstraint{\ket*{\psi^{0}_{1}} = \ket*{0}, \ket*{\psi^{1}_{1}} = \ket*{1}}
  \label{eq:istate_con}
  \addConstraint{{\textstyle \int_{t}} a_{1} = a_{1} = \mathrm{d}_{t} a_{1} = 0}
  \label{eq:ic_con}
  \addConstraint{\ket*{\psi^{i}_{N}} = \ket*{\psi^{i}_{T}}
    \ \forall \  i} \label{eq:tstate_con}
  \addConstraint{{\textstyle \int_{t}} a_{N} = a_{N} = 0} \label{eq:znf_con}
  \addConstraint{{\lvert \braket{\psi^{i}_{k}}{\psi^{i}_{k}}
      \rvert}^{2} = 1 \ \forall \ i, k} \label{eq:statenorm_con}
  \addConstraint{|a_{k}| \leq 0.5 \ \textrm{GHz} \ \forall \ k.} \label{eq:amp_con}
\end{mini!}

Next, we remark on our problem formulation.
We put a cost function at all time steps
because it benefits the iLQR solving stage \cite{Jackson2020altroc};
although this may incentivize early achievement of the desired gate,
as in Ref. \cite{leung2017speedup}, we are primarily concerned
with achieving the gate at the final time step, which the target-state
constraint \eqref{eq:tstate_con} ensures.
Additionally, the target-state constraint
requires the final state to match the target state, including its global phase,
up to our chosen maximum constraint violation $\sim 10^{-8}$.
If we did not impose this constraint, the optimizer would be
allowed to sacrifice the closed-system gate error to achieve better
performance on the other cost functions, which is undesirable.
To enforce a constraint in standard QOC frameworks,
the prefactor for the constraint function is manually increased
between separate optimization instances until the constraint is satisfied
\cite{heeres2017implementing, leung2017speedup, reinhold2019controlling},
which becomes infeasible for more than one constraint.
ALM automates these prefactor updates to find
a solution that satisfies all of the given constraints.
Hence, ALTRO's ability to handle multiple constraints makes it
an attractive solver for QOC problems.

In extraordinarily difficult cases of
QOC, it may be impossible
to obey the physics of the system and achieve the desired gate \cite{abdelhafez2020universal},
i.e., the dynamics constraint \eqref{eq:dyn_con}
and the target-state constraint \eqref{eq:tstate_con} may be mutually unsatisfiable.
In this case, the prefactors for the constraint function terms
in the ALM objective will tend to infinity -- leading to numerical instability -- and the
optimization will not converge. To maintain a constrained approach in this situation,
the maximum constraint violation for the target-state constraint can be raised
to a level commensurate with the minimum acceptable gate error.

Finally, for ALTRO's first indirect stage,
the augmented states are obtained explicitly with the discrete
dynamics function, so the dynamics constraint and initial conditions
\eqref{eq:dyn_con}-\eqref{eq:ic_con} are satisfied by construction.
In this stage, the rest of the constraint functions \eqref{eq:tstate_con}-\eqref{eq:amp_con}
are added to the objective in their isomorphism-equivalent form \eqref{eq:isomorphism}.
Conversely, for the second direct stage, all of the constraints
\eqref{eq:dyn_con}-\eqref{eq:amp_con} are used to define
the projection onto the constraint manifold, and the objective is unmodified.
Hence, the quantum states become
free parameters that are adjusted to satisfy the TDSE.
Although the final solution's deviation from the TDSE is never
more than the maximum constraint violation,
we explicitly integrate the TDSE when reporting gate errors to ensure accuracy.
Exploring the benefit of direct optimization approaches
for QOC is an interesting direction for future work.
