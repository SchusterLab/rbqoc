\section{Robustness to Static Parameter Deviations \label{sec:static}}
\todo{standardize gate time vs gate duration} We have formulated the quantum optimal control
problem as an open loop optimization problem, i.e.
feedback from the experiment is not incorporated in optimization.
However, the device typically deviates from the Hamiltonian we use in optimization,
leading to poor experimental performance. We combat errors
of this form using robust control techniques,
making the state evolution insensitive
to Hamiltonian parameter deviations. As an example,
we mitigate errors arising from the drift and finite measurement
precision of the qubit frequency which modifies \eqref{eq:hamiltonian}
by $f_{q} \gets f_{q} + \delta f_{q}$.
We consider three robust control techniques:
the sampling method, the unscented sampling method,
and the derivative method.

The sampling method simultaneously optimizes over copies of a state,
each of which evolves with a distinct deviant parameter value.
A pair of two sample states $\psi_{\pm}$
is appended to the augmented state vector \eqref{eq:astatecontrols}
. The samples are initialized in the same state.
Four pairs
are appended in total corresponding to the initial states
$\{\ket{0}, \ket{1}, (\ket{0} + i\ket{1}) / \sqrt{2},
(\ket{0} - \ket{1}) / \sqrt{2}\}$.
The initial states are chosen
so that their outer products span the operators on the
Hilbert space  \cite{chow2009randomized}.
The discrete dynamics \eqref{eq:dyn_con} is modified so that the
samples evolve under the Hamiltonian given in \eqref{eq:hamiltonian}
with $f_{q} \gets f_{q} \pm \sigma_{f_{q}}$ for a fixed $\sigma_{f_{q}}$.
The final state
for each sample is the image of its initial state
under the desired gate. Deviations from the final state are
penalized in the objective \eqref{eq:costfun}.

For the unscented sampling method, $2(2n + d)$ samples
are appended to the augmented state vector \eqref{eq:astatecontrols}
for each initial state from the operator basis. Here $2n = 4$ is twice the
dimension of the Hilbert space, resulting from the isomorphism \eqref{eq:isomorphism},
and $d = 1$ is the number of deviant parameters. The samples
are used to represent a Gaussian distribution over all $2n$
elements of the initial state, modeling
the uncertainty in the state as a result of the uncertainty in
the deviant parameter. Each sample evolves under the Hamiltonian
given in \eqref{eq:hamiltonian} with $f_{q} \gets f_{q} + \delta f_{q}$.
The qubit frequency detuning $\delta f_{q}$ is determined by the statistics
of the ensemble of samples at each knot point.
The discrete dynamics \eqref{eq:dyn_con} is modified to 
evolve the samples under the deviant Hamiltonian
and then apply the unscented transformation to the ensemble,
accurately preserving the first and second moments
of the distribution.
As in the sampling method,
deviations from the final state are penalized according to \eqref{eq:costfun}.
A detailed procedure for the unscented transformation is given
in Appendix \ref{appendix:unscented}.

The derivative method penalizes the sensitivty of the state
to the deviant parameter, which is encoded in the ($l$\textsuperscript{th}-order)
derivative $\partial_{f_{q}}^{l} \psi$. In the $m$\textsuperscript{th}-order
derivative method, all state derivatives of order $1, \dots, m$
are appended to the augmented state vector \eqref{eq:astatecontrols}
for each initial state in the operator basis.
The norms of the state derivatives are penalized
in \eqref{eq:costfun} by setting the corresponding final states to zero.
The state derivatives could be obtained in the discrete dynamics \eqref{eq:dyn_con}
with backwards mode differentiation.
Naive automatic differentiation
would differentiate all dynamics at knot points
$1, \dots, k - 1$ to obtain the state derivative at knot point $k$, requiring
$O(N^{2})$ matrix multiplications. Instead, we 
employ forwards mode differentiation on the TDSE to obtain coupled dynamics
which require $O(N)$ matrix multiplications to integrate.
For example, the dynamics for the $1$\textsuperscript{st}-order derivative method are,
\begin{align}
  i \hbar \frac{d}{dt} \ket{\psi} &= H \ket{\psi}\\
  i \hbar \frac{d}{dt} \ket{\partial_{f_{q}}\psi} &=
  H \ket{\partial_{f_{q}} \psi} +
  (\partial_{f_{q}} H) \ket{\psi}
  \label{eq:d1dyn}
\end{align}
Exponential integrators that account for the non-linear
term in \eqref{eq:d1dyn} may be used to efficiently integrate the coupled dynamics,
see Appendix \ref{appendix:derivative}. For timing results
and an analysis of how the three robust methods scale to larger Hilbert spaces
and more deviant parameters,
consult Appendix \ref{appendix:time}.

We task these methods with achieving
a $Z/2$ gate subject to a static qubit frequency detuning.
We take $\sigma_{f_{q}} / f_{q} = 1\%$ to be one standard devation, and equip
the sampling methods accordingly. We compute gate errors for each method
by evolving the optimized trajectory under the Hamiltonian in \eqref{eq:hamiltonain}
with $f_{q} \gets f_{q} + \delta f_{q}$ at the stated qubit frequency detuning.

We compare the numerical methods
to an analytically derived $Z/2$ gate, see Figure \ref{fig:statica}. 
The analytic gate corresponds to
idling at the flux frustration point $a = 0$. It
is at the device's speed limit for a $Z/2$ gate $t_{Z/2} = 1 / 4 f_{q}$ and
is simple to derive. Its erroneous rotation angle $2 \pi t_{Z/2} \delta f_{q}$ is linearly sensitive to
the qubit frequency detuning, resulting in a gate error that is quadratically sensitive
to the qubit frequency detutning.
At a one-percent
qubit frequency detuning ($\delta f_{q} / f_{q} = 1\%$)
the analytic gate achieves a gate error $\sim 4.5 \cdot 10^{-5}$,
which is sufficient for quantum error correction.
Although the analytic $Z/2$ gate performs well, it
only works at the gate time $t_{Z/2}$. The ability to perform $Z$ rotations in arbitrary times is critical
for multi-qubit experiments, where the qubits operate at different frequencies $f_{q, i} \neq f_{q, j}$.
Each numerical method is able to find solutions at
all gate times above $t_{Z/2}$, see Figure \ref{fig:staticb}.
These numerical methods offer an effective scheme for synchronizing
multi-qubit experiments.

The sampling and unscented sampling methods combine idling periods
with time-anti-symmetric ramps.
The gate error at $\delta f_{q} / f_{q} = 1\%$ for the sampling method
does not improve substantially over the
range of gate durations. The unscented sampling method
achieves linear decreases in its gate error at $\delta f_{q} / f_{q} = 1\%$ with longer gate durations
until half the larmor period $1 / 2 f_{q}$ after which it achieves a consistent
gate error $\sim 3.5 \cdot 10^{-5}$.

The derivative methods converge on qualitatively similar solutions that
use fast traingle pulses at the boundaries and balance time
on either side of the flux-frustration point symmetrically at low amplitudes.
Both methods achieve a super-linear scaling in their gate error as
a function of the gate duration. The gate error for the 1\textsuperscript{st}-order
derivative method approaches zero at the larmor period $1 / f_{q}$, see Figure \ref{fig:staticc}.
We believe the 1\textsuperscript{st}-order method outperforms the 2\textsuperscript{nd}-order
method due to the low contribution of second-order
terms to the gate error in this deviation regime, see Appendix \ref{appendix:derivative}.
The vanishing gate error at longer gate durations exhibited by the derivative methods
is reminiscent of the
ability of composite pulses to mitigate parameter deviation errors to arbitrary
order with sufficiently many pulses \cite{merrill2014progress}.
It is difficult to choose an appropriate composite pulse
for the problem studied here due to our Hamiltonian and experimental constraints.
We propose comparisons between composite pulses and numerical techniques
for future work.

%% F3
\begin{figure*}[ht]
  \begin{subfigure}{.4\textwidth}
    \includegraphics[width=\linewidth]{assets/f3a.png}
    \caption{}
    \label{fig:stochastica}
  \end{subfigure}\hspace{0.025\textwidth}
  \begin{subfigure}{.4\textwidth}
    \includegraphics[width=\linewidth]{assets/f3b.png}
        \caption{}
    \label{fig:stochasticb}
  \end{subfigure}
  \caption{
    \todo{fix the size of the images and where are x axis labels?}
    (a) $X/2$ gates robust to flux offsets constructed with the analytic,
    sampling, unscented sampling, and the 1\textsuperscript{st}-
    and 2\textsuperscript{nd}-order derivative methods. The gates shown
    are the solutions at the analytic gate time.
    (b) Simulation of stochastic 1/$f$ flux noise for
    successive gate applications. The cumulative
    gate error is computed after each gate application.
  }
  \label{fig:stochastic}
\end{figure*}
